trigger: none
pr:
  branches:
    include:
      - main
pool:
  name: Self-Hosted   # Your agent pool name

stages:
  - stage: ValidateMigration
    displayName: 'Flyway Migration Validation (Windows Agent)'
    jobs:
      - job: EnsureTools
        displayName: 'Ensure Java and Flyway Installed'
        pool:
          name: Self-Hosted
          demands:
            - Agent.OS -equals Windows_NT
        steps:
          - checkout: none
# âœ… Check and Install Java (if not found)
          - task: PowerShell@2
            displayName: 'Check and Install Java (via command only)'
            inputs:
               targetType: 'inline'
               script: |
                  if (Get-Command java -ErrorAction SilentlyContinue) {
                    Write-Host "Java is already installed."
                      } else {
                        Write-Host "Java is NOT installed. Installing OpenJDK 11..."
                      choco install -y openjdk11
                    }
          - task: PowerShell@2
            displayName: 'Check and Install Flyway CLI (any version)'
            inputs:
                targetType: 'inline'
                script: |
                 if (Get-Command flyway -ErrorAction SilentlyContinue) {
                          Write-Host "Flyway CLI is already installed."
                  } else {
                    Write-Host "Flyway CLI is NOT installed. Installing..."
                    $flywayZip = "$(Build.SourcesDirectory)\flyway.zip"
                    Invoke-WebRequest -Uri "https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/9.8.1/flyway-commandline-9.8.1-windows-x64.zip" -OutFile $flywayZip
                    Expand-Archive -Path $flywayZip -DestinationPath "$(Build.SourcesDirectory)\flyway"
                    $flywayPath = "$(Build.SourcesDirectory)\flyway\flyway-9.8.1"
                    $env:Path = "$flywayPath;$env:Path"
                    Write-Host "Flyway CLI installed successfully."
                  }